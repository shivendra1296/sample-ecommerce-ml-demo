name: CI/CD with ML-Powered Quality Gate

on:
  push:
    branches: [ main, risky-deployment, risky-deployment-* ]
  pull_request:
    branches: [ main ]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 2
    
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: ðŸ“¦ Install dependencies
      id: install
      run: |
        START=$SECONDS
        npm install
        DURATION=$((SECONDS - START))
        echo "duration=$DURATION" >> $GITHUB_OUTPUT
    
    - name: ðŸ§ª Run tests
      id: test
      continue-on-error: true
      run: |
        START=$SECONDS
        npm test 2>&1 | tee test_output.txt
        TEST_EXIT=${PIPESTATUS[0]}
        DURATION=$((SECONDS - START))
        
        PASSED=$(grep -oP '\d+(?= passed)' test_output.txt || echo "1")
        FAILED=$(grep -oP '\d+(?= failed)' test_output.txt || echo "0")
        TOTAL=$((PASSED + FAILED))
        
        if [ $TOTAL -eq 0 ]; then
          TOTAL=3
          PASSED=1
        fi
        
        echo "duration=$DURATION" >> $GITHUB_OUTPUT
        echo "total=$TOTAL" >> $GITHUB_OUTPUT
        echo "passed=$PASSED" >> $GITHUB_OUTPUT
    
    - name: ðŸ” Security scan
      id: security
      run: |
        if [[ "${{ github.ref }}" == *"risky"* ]]; then
          CRITICAL=2
          HIGH=5
        else
          CRITICAL=0
          HIGH=0
        fi
        
        echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
        echo "high=$HIGH" >> $GITHUB_OUTPUT
    
    - name: ðŸ“Š Calculate metrics
      id: metrics
      run: |
        TOTAL=${{ steps.test.outputs.total }}
        PASSED=${{ steps.test.outputs.passed }}
        
        if [ "$TOTAL" -gt 0 ]; then
          PASS_RATE=$(awk "BEGIN {printf \"%.2f\", $PASSED / $TOTAL}")
        else
          PASS_RATE="0.33"
        fi
        
        CODE_CHANGES=$(git diff --stat HEAD~1 2>/dev/null | tail -1 | grep -oP '\d+' | head -1 || echo "50")
        
        if [[ "${{ github.ref }}" == *"risky"* ]]; then
          CODE_CHANGES=450
        fi
        
        echo "pass_rate=$PASS_RATE" >> $GITHUB_OUTPUT
        echo "code_changes=$CODE_CHANGES" >> $GITHUB_OUTPUT
    
    - name: ðŸ¤– ML Quality Gate
      id: ml_gate
      env:
        ML_API_URL: ${{ secrets.ML_API_URL }}
      run: |
        echo "=========================================="
        echo "ðŸ¤– ML Quality Gate"
        echo "=========================================="
        
        TOTAL_DURATION=$((${{ steps.install.outputs.duration }} + ${{ steps.test.outputs.duration }}))
        
        if [[ "${{ github.ref }}" == *"risky"* ]]; then
          TOTAL_DURATION=1200
          CPU=85.0
          MEM=6000.0
          STAGES=15
          COV=55.0
          HOUR=22
          DAY=5
          PREV=0.35
        else
          CPU=45.0
          MEM=2000.0
          STAGES=5
          COV=80.0
          HOUR=$((10#$(date +%H)))
          DAY=$(date +%w | sed 's/^0*//')
          PREV=0.05
        fi
        
        PASS_RATE="${{ steps.metrics.outputs.pass_rate }}"
        CHANGES=${{ steps.metrics.outputs.code_changes }}
        CRIT=${{ steps.security.outputs.critical }}
        HIGH=${{ steps.security.outputs.high }}
        
        echo "Metrics: duration=$TOTAL_DURATION, pass=$PASS_RATE, changes=$CHANGES, hour=$HOUR, day=$DAY"
        
        # Build JSON using jq
        RESPONSE=$(jq -n \
          --argjson dur "$TOTAL_DURATION" \
          --argjson pass "$PASS_RATE" \
          --argjson changes "$CHANGES" \
          --argjson cpu "$CPU" \
          --argjson mem "$MEM" \
          --argjson crit "$CRIT" \
          --argjson high "$HIGH" \
          --argjson stages "$STAGES" \
          --argjson cov "$COV" \
          --argjson hour "$HOUR" \
          --argjson day "$DAY" \
          --argjson prev "$PREV" \
          '{
            execution_duration_sec: $dur,
            test_pass_rate: $pass,
            code_change_volume: $changes,
            cpu_usage_avg: $cpu,
            memory_usage_avg: $mem,
            vuln_critical: $crit,
            vuln_high: $high,
            stage_count: $stages,
            test_coverage_pct: $cov,
            execution_hour: $hour,
            execution_day_of_week: $day,
            previous_failure_rate: $prev
          }' | tee payload.json | \
          curl -s -X POST ${ML_API_URL}/health/score \
            -H "Content-Type: application/json" \
            -d @-)
        
        echo ""
        echo "ML API Response:"
        echo "$RESPONSE" | jq '.'
        
        HEALTH_SCORE=$(echo "$RESPONSE" | jq -r '.health_score // empty')
        STATUS=$(echo "$RESPONSE" | jq -r '.status // empty')
        
        if [ -z "$HEALTH_SCORE" ]; then
          echo "::error::ML API failed"
          exit 1
        fi
        
        echo "health_score=$HEALTH_SCORE" >> $GITHUB_OUTPUT
        echo "status=$STATUS" >> $GITHUB_OUTPUT
        
        FAILURE=$(echo "$RESPONSE" | jq -r '.component_scores.failure_risk')
        ANOMALY=$(echo "$RESPONSE" | jq -r '.component_scores.anomaly_detection')
        POLICY=$(echo "$RESPONSE" | jq -r '.component_scores.policy_compliance')
        
        {
          echo "### ðŸ¤– ML Quality Gate"
          echo "| Metric | Value |"
          echo "|--------|-------|"
          echo "| Health Score | **$HEALTH_SCORE/100** |"
          echo "| Status | **$STATUS** |"
          echo ""
          echo "### ðŸ“Š Components"
          echo "| Component | Score |"
          echo "|-----------|-------|"
          echo "| Failure Risk | $FAILURE |"
          echo "| Anomaly Detection | $ANOMALY |"
          echo "| Policy Compliance | $POLICY |"
        } >> $GITHUB_STEP_SUMMARY
        
        if [ "$STATUS" = "CRITICAL" ] || [ "$STATUS" = "DEGRADED" ]; then
          {
            echo ""
            echo "## âŒ DEPLOYMENT BLOCKED"
            echo "Health: $HEALTH_SCORE/100"
          } >> $GITHUB_STEP_SUMMARY
          echo "::error::Blocked: $HEALTH_SCORE"
          exit 1
        else
          {
            echo ""
            echo "## âœ… DEPLOYMENT APPROVED"
          } >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ðŸš€ Deploy
      if: success()
      run: |
        echo "ðŸš€ Deploying (Health: ${{ steps.ml_gate.outputs.health_score }})"
