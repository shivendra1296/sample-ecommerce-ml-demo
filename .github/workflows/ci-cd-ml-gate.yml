name: CI/CD with ML-Powered Quality Gate

on:
  push:
    branches: [ main, risky-deployment ]
  pull_request:
    branches: [ main ]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 2
    
    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: ðŸ“¦ Install dependencies
      id: install
      run: |
        START=$SECONDS
        npm install
        DURATION=$((SECONDS - START))
        echo "duration=$DURATION" >> $GITHUB_OUTPUT
    
    - name: ðŸ§ª Run tests
      id: test
      continue-on-error: true
      run: |
        START=$SECONDS
        npm test 2>&1 | tee test_output.txt
        TEST_EXIT=${PIPESTATUS[0]}
        DURATION=$((SECONDS - START))
        
        PASSED=$(grep -oP '\d+(?= passed)' test_output.txt || echo "1")
        FAILED=$(grep -oP '\d+(?= failed)' test_output.txt || echo "0")
        TOTAL=$((PASSED + FAILED))
        
        if [ $TOTAL -eq 0 ]; then
          TOTAL=3
          PASSED=1
        fi
        
        echo "duration=$DURATION" >> $GITHUB_OUTPUT
        echo "total=$TOTAL" >> $GITHUB_OUTPUT
        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        echo "exit_code=$TEST_EXIT" >> $GITHUB_OUTPUT
    
    - name: ðŸ” Security scan
      id: security
      run: |
        # Detect vulnerabilities based on branch
        if [[ "${{ github.ref }}" == *"risky-deployment"* ]]; then
          # Risky branch has vulnerabilities
          CRITICAL=2
          HIGH=5
          echo "âš ï¸ Security issues detected!"
        else
          # Main branch is clean
          CRITICAL=0
          HIGH=0
        fi
        
        echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
        echo "high=$HIGH" >> $GITHUB_OUTPUT
    
    - name: ðŸ“Š Calculate pipeline metrics
      id: metrics
      run: |
        if [ "${{ steps.test.outputs.total }}" -gt 0 ]; then
          PASS_RATE=$(echo "scale=2; ${{ steps.test.outputs.passed }} / ${{ steps.test.outputs.total }}" | bc)
        else
          PASS_RATE=0.33
        fi
        
        CODE_CHANGES=$(git diff --stat HEAD~1 2>/dev/null | tail -1 | grep -oP '\d+' | head -1 || echo "50")
        
        # Risky branch has large changes
        if [[ "${{ github.ref }}" == *"risky-deployment"* ]]; then
          CODE_CHANGES=450
        fi
        
        echo "pass_rate=$PASS_RATE" >> $GITHUB_OUTPUT
        echo "code_changes=$CODE_CHANGES" >> $GITHUB_OUTPUT
    
    - name: ðŸ¤– ML-Powered Quality Gate
      id: ml_gate
      env:
        ML_API_URL: ${{ secrets.ML_API_URL }}
      run: |
        echo "=========================================="
        echo "ðŸ¤– Calling ML Quality Gate API"
        echo "=========================================="
        
        TOTAL_DURATION=$((${{ steps.install.outputs.duration }} + ${{ steps.test.outputs.duration }}))
        
        # Risky deployments have longer duration
        if [[ "${{ github.ref }}" == *"risky-deployment"* ]]; then
          TOTAL_DURATION=1200
        fi
        
        DAY_OF_WEEK=$(date +%w)
        
        echo "Pipeline Metrics:"
        echo "- Duration: $TOTAL_DURATION seconds"
        echo "- Test Pass Rate: ${{ steps.metrics.outputs.pass_rate }}"
        echo "- Code Changes: ${{ steps.metrics.outputs.code_changes }} lines"
        echo "- Critical Vulns: ${{ steps.security.outputs.critical }}"
        echo "- High Vulns: ${{ steps.security.outputs.high }}"
        
        RESPONSE=$(curl -s -X POST ${ML_API_URL}/health/score \
          -H "Content-Type: application/json" \
          -d "{
            \"execution_duration_sec\": $TOTAL_DURATION,
            \"test_pass_rate\": ${{ steps.metrics.outputs.pass_rate }},
            \"code_change_volume\": ${{ steps.metrics.outputs.code_changes }},
            \"cpu_usage_avg\": 85.0,
            \"memory_usage_avg\": 6000.0,
            \"vuln_critical\": ${{ steps.security.outputs.critical }},
            \"vuln_high\": ${{ steps.security.outputs.high }},
            \"stage_count\": 15,
            \"test_coverage_pct\": 55.0,
            \"execution_hour\": 22,
            \"execution_day_of_week\": 5,
            \"previous_failure_rate\": 0.35
          }")
        
        echo ""
        echo "ML API Response:"
        echo "$RESPONSE" | jq '.'
        
        HEALTH_SCORE=$(echo "$RESPONSE" | jq -r '.health_score // empty')
        STATUS=$(echo "$RESPONSE" | jq -r '.status // empty')
        ACTION=$(echo "$RESPONSE" | jq -r '.recommended_action // empty')
        
        if [ -z "$HEALTH_SCORE" ]; then
          echo "::error::Failed to get valid response from ML API"
          exit 1
        fi
        
        echo "health_score=$HEALTH_SCORE" >> $GITHUB_OUTPUT
        echo "status=$STATUS" >> $GITHUB_OUTPUT
        echo "action=$ACTION" >> $GITHUB_OUTPUT
        
        {
          echo "### ðŸ¤– ML Quality Gate Results"
          echo ""
          echo "| Metric | Value |"
          echo "|--------|-------|"
          echo "| **Health Score** | **$HEALTH_SCORE/100** |"
          echo "| **Status** | **$STATUS** âš ï¸ |"
          echo "| **Recommendation** | $ACTION |"
          echo ""
        } >> $GITHUB_STEP_SUMMARY
        
        FAILURE_RISK=$(echo "$RESPONSE" | jq -r '.component_scores.failure_risk // empty')
        ANOMALY_SCORE=$(echo "$RESPONSE" | jq -r '.component_scores.anomaly_detection // empty')
        POLICY_SCORE=$(echo "$RESPONSE" | jq -r '.component_scores.policy_compliance // empty')
        
        {
          echo "### ðŸ“Š Component Scores"
          echo ""
          echo "| Component | Score |"
          echo "|-----------|-------|"
          echo "| Failure Risk | $FAILURE_RISK âš ï¸ |"
          echo "| Anomaly Detection | $ANOMALY_SCORE |"
          echo "| Policy Compliance | $POLICY_SCORE âš ï¸ |"
          echo ""
          echo "### âš ï¸ Issues Detected"
          echo ""
          echo "- âŒ **Tests failing**: ${{ steps.test.outputs.passed }}/${{ steps.test.outputs.total }} passed"
          echo "- âŒ **Critical vulnerabilities**: ${{ steps.security.outputs.critical }}"
          echo "- âŒ **High vulnerabilities**: ${{ steps.security.outputs.high }}"
          echo "- âŒ **Large code changes**: ${{ steps.metrics.outputs.code_changes }} lines"
          echo ""
        } >> $GITHUB_STEP_SUMMARY
        
        if [ "$STATUS" = "CRITICAL" ] || [ "$STATUS" = "DEGRADED" ]; then
          {
            echo "## âŒ **DEPLOYMENT BLOCKED BY ML QUALITY GATE**"
            echo ""
            echo "### Why was this blocked?"
            echo ""
            echo "The ML model analyzed your pipeline and determined that deploying this code"
            echo "would have a **${FAILURE_RISK}% probability of causing production issues**."
            echo ""
            echo "**Health Score**: $HEALTH_SCORE/100 (threshold: 50)"
            echo ""
            echo "### What should you do?"
            echo ""
            echo "1. Fix failing tests"
            echo "2. Address security vulnerabilities"
            echo "3. Review large code changes"
            echo "4. Run tests locally before pushing"
          } >> $GITHUB_STEP_SUMMARY
          echo "::error::ðŸš« Deployment BLOCKED - Health score: $HEALTH_SCORE, Status: $STATUS"
          exit 1
        else
          {
            echo "âœ… **Deployment APPROVED by ML Quality Gate**"
            echo ""
            echo "Health score $HEALTH_SCORE meets deployment criteria."
          } >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ðŸš€ Deploy to Production
      if: success()
      run: |
        echo "=========================================="
        echo "ðŸš€ Deploying to Production"
        echo "=========================================="
        echo "Health Score: ${{ steps.ml_gate.outputs.health_score }}"
        echo "âœ“ Deployment successful!"
